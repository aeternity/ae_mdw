# GraphQL API

This middleware exposes a full-featured GraphQL API powered by Absinthe.
It runs alongside the existing REST endpoints and provides a typed, queryable
interface to blocks, transactions, accounts, names, tokens (AEX-9 and AEX-141),
channels, oracles, stats, DEX swaps, transfers, wealth, and system status.

## Endpoints

- HTTP endpoint: `/graphql`
- Playground UI (non-production only): `/graphiql`

These routes are mounted in the Phoenix router and are available wherever the
MDW is running (dev, test, prod). In non-production environments, the GraphiQL
Playground is enabled for interactive exploration.

Example base URL in local dev: `http://localhost:4000/graphql`

### Query surface overview

The schema is organized by domain (accounts, blocks, transactions, contracts,
names, tokens, channels, oracles, stats, DEX swaps, transfers, wealth, status).
Each domain exposes multiple query fields under the root `Query` type.

To discover all available queries, their arguments, return types, and
descriptions:

1. Use the interactive GraphiQL Playground at `/graphiql` (non-production).
2. Or generate static HTML docs with SpectaQL (see section below).

Those autogenerated docs stay authoritative; this file intentionally omits the
exhaustive field list to avoid drift.

## Pagination and filtering

Most list queries support cursor-based pagination:

- Arguments supported by many list fields:
  - `cursor: String` — opaque cursor pointing to a position in the result set.
  - `limit: Int` — number of items to return (1–100, default 10).
    Values greater than 100 are capped to 100; values below 1 are increased to 1.
  - `direction: Direction = BACKWARD` — either `FORWARD` or `BACKWARD`.
  - Some fields (notably those with on-chain height filters) also accept
    `fromHeight: Int` and `toHeight: Int`.

- Page response shape:
  - `data: [T]` — the items for the requested page.
  - `prevCursor: String`
  - `nextCursor: String`

### Pagination tips

Use the following guidelines when paginating:

- Use the `nextCursor` value from a response to fetch the next page.
- Use `prevCursor` for the previous page.
- When no `cursor` is provided, results will start from the most recent
  data; combine with `fromHeight`/`toHeight` when you need range-scoped
  pagination.

## Example queries

### Blocks

Fetch the 3 most recent key blocks:

```graphql
query {
  keyBlocks(limit: 3) {
    data { height hash time miner transactionsCount }
    nextCursor
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query {
  keyBlocks(limit: 3) {
    data { height hash time miner transactionsCount }
    nextCursor
  }
}'
```

Fetch micro blocks of a key block by height:

```graphql
query($height: Int!) {
  microBlocksOfKeyBlockAtHeight(height: $height, limit: 5) {
    data { microBlockIndex hash time gas transactionsCount }
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($height: Int!) {
  microBlocksOfKeyBlockAtHeight(height: $height, limit: 5) {
    data { microBlockIndex hash time gas transactionsCount }
  }
}' \
  --data-urlencode 'variables={"height":100000}'
```

### Transactions

Single transaction by hash:

```graphql
query($hash: String!) {
  transaction(hash: $hash) {
    hash
    blockHash
    type
    txIndex
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($hash: String!) {
  transaction(hash: $hash) {
    hash
    blockHash
    type
    txIndex
  }
}' \
  --data-urlencode 'variables={"hash":"th_2qc...YOUR_TX_HASH..."}'
```

Filter transactions by type and account:

```graphql
query($types: [String!], $account: String) {
  transactions(type: $types, account: $account, limit: 10) {
    data { hash type blockHash }
    nextCursor
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($types: [String!], $account: String) {
  transactions(type: $types, account: $account, limit: 10) {
    data { hash type blockHash }
    nextCursor
  }
}' \
  --data-urlencode 'variables={"types":["SpendTx"],"account":"ak_2a...YOUR_ACCOUNT..."}'
```

### Names

Get a name by plain name or name hash:

```graphql
query { name(id: "support.chain") { name active ownership expireHeight } }
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query {
  name(id: "support.chain") { name active ownership expireHeight }
}'
```

List names owned by an account:

```graphql
query($owner: String!) {
  names(ownedBy: $owner, limit: 10) {
    data { name hash active }
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($owner: String!) {
  names(ownedBy: $owner, limit: 10) {
    data { name hash active }
  }
}' \
  --data-urlencode 'variables={"owner":"ak_2a...YOUR_ACCOUNT..."}'
```

### AEX-9 (Fungible tokens)

Token info by contract:

```graphql
query($id: String!) {
  aex9Contract(id: $id) { symbol name decimals }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!) {
  aex9Contract(id: $id) { symbol name decimals }
}' \
  --data-urlencode 'variables={"id":"ct_2u...YOUR_CONTRACT..."}'
```

Balances within a token contract:

```graphql
query($id: String!) {
  aex9ContractBalances(id: $id, limit: 5) {
    data { accountId balance }
    nextCursor
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!) {
  aex9ContractBalances(id: $id, limit: 5) {
    data { accountId balance }
    nextCursor
  }
}' \
  --data-urlencode 'variables={"id":"ct_2u...YOUR_CONTRACT..."}'
```

### AEX-141 (NFTs)

Contract and a single token:

```graphql
query($id: String!, $tokenId: String!) {
  aex141Contract(id: $id) { name symbol }
  aex141ContractToken(contractId: $id, tokenId: $tokenId) {
    tokenId
    contractId
    owner
    metadata
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!, $tokenId: String!) {
  aex141Contract(id: $id) { name symbol }
  aex141ContractToken(contractId: $id, tokenId: $tokenId) {
    tokenId
    contractId
    owner
    metadata
  }
}' \
  --data-urlencode 'variables={"id":"ct_2n...YOUR_NFT_CONTRACT...","tokenId":"1"}'
```

### Accounts

Account activities (optionally filter by type):

```graphql
query($id: String!) {
  accountActivities(id: $id, type: transactions, limit: 20) {
    data { type height blockHash payload blockTime }
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!) {
  accountActivities(id: $id, type: transactions, limit: 20) {
    data { type height blockHash payload blockTime }
  }
}' \
  --data-urlencode 'variables={"id":"ak_2a...YOUR_ACCOUNT..."}'
```

### Oracles

```graphql
query($id: String!) {
  oracle(id: $id) { id queryFee ttl }
  oracleQueries(id: $id, limit: 5) { data { id query blockHash } }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!) {
  oracle(id: $id) { id queryFee ttl }
  oracleQueries(id: $id, limit: 5) { data { id query blockHash } }
}' \
  --data-urlencode 'variables={"id":"ok_2o...YOUR_ORACLE..."}'
```

### Channels

```graphql
query($id: String!) {
  channel(id: $id) { id state }
  channelUpdates(id: $id, limit: 10) { data { type height } }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($id: String!) {
  channel(id: $id) { id state }
  channelUpdates(id: $id, limit: 10) { data { type height } }
}' \
  --data-urlencode 'variables={"id":"ch_2v...YOUR_CHANNEL..."}'
```

### DEX swaps

```graphql
query($account: String!) {
  accountSwaps(accountId: $account, limit: 10) {
    data { txHash amountIn amountOut tokenIn tokenOut }
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($account: String!) {
  accountSwaps(accountId: $account, limit: 10) {
    data { txHash amountIn amountOut tokenIn tokenOut }
  }
}' \
  --data-urlencode 'variables={"account":"ak_2a...YOUR_ACCOUNT..."}'
```

### Transfers (AE + tokens)

```graphql
query($account: String) {
  transfers(account: $account, limit: 10) {
    data { kind amount sender recipient height }
  }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query($account: String) {
  transfers(account: $account, limit: 10) {
    data { kind amount sender recipient height }
  }
}' \
  --data-urlencode 'variables={"account":"ak_2a...YOUR_ACCOUNT..."}'
```

### Stats and health

```graphql
query {
  stats { height txsCount contractsCount namesCount }
  status { network mdwHeight nodeHeight syncProgress }
}
```

```bash
curl -sS http://localhost:4000/graphql \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'query=query {
  stats { height txsCount contractsCount namesCount }
  status { network mdwHeight nodeHeight syncProgress }
}'
```

## Using the Playground

In non-production environments, open `/graphiql` in a browser. The Playground
points to `/graphql` and supports query history, variables, and schema
introspection.

## Generating static docs (optional)

This repo includes a SpectaQL config under
`docs/graphql_doc_gen/spectaql-config.yml`. To generate static HTML docs
locally:

1. Ensure the MDW is running locally.
2. Navigate to `docs/graphql_doc_gen` and run `docker compose up`.
3. The generated docs will be available at `http://localhost:4400`.

```bash
# from the repo root
cd docs/graphql_doc_gen
docker compose up
```

## Notes

- Authentication: The GraphQL API is public like the REST API; rate-limiting or
  auth can be added behind a reverse proxy if needed.
- CORS: The service is designed for server-to-server and UI usage; configure
  CORS at the gateway if you expose it cross-origin.
- Errors: GraphQL errors are returned in the `errors` section of the response
  per the GraphQL spec, with HTTP 200 for successful query execution.
